name: Release Build

on:
  pull_request:
    types: [closed]
    branches:
      - master

env:
  CARGO_TERM_COLOR: always

jobs:
  prepare-release:
    # Only run if PR was merged
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      has_version: ${{ steps.check_version.outputs.has_version }}
      version_tag: ${{ steps.check_version.outputs.version_tag }}
      version: ${{ steps.check_version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check PR title for version tag
        id: check_version
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: ${PR_TITLE}"
          
          # Check if title contains version pattern (e.g., v1.2.3, v0.1.0-beta, etc.)
          if echo "${PR_TITLE}" | grep -qE 'v[0-9]+\.[0-9]+\.[0-9]+'; then
            # Extract version from title
            VERSION=$(echo "${PR_TITLE}" | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+[a-zA-Z0-9.-]*' | head -1)
            echo "has_version=true" >> $GITHUB_OUTPUT
            echo "version_tag=${VERSION}" >> $GITHUB_OUTPUT
            echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
            echo "Found version tag: ${VERSION}"
          else
            echo "has_version=false" >> $GITHUB_OUTPUT
            # Get latest tag to update
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "version_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
            echo "version=${LATEST_TAG#v}" >> $GITHUB_OUTPUT
            echo "No version tag in title, will update latest tag: ${LATEST_TAG}"
          fi
      
      - name: Delete existing release if updating
        if: steps.check_version.outputs.has_version == 'false'
        run: |
          VERSION_TAG="${{ steps.check_version.outputs.version_tag }}"
          echo "Deleting existing release: ${VERSION_TAG}"
          gh release delete "${VERSION_TAG}" --yes || true
          
          echo "Deleting existing tag: ${VERSION_TAG}"
          git push origin --delete "${VERSION_TAG}" || true
        env:
          GH_TOKEN: ${{ github.token }}
  
  build-binaries:
    needs: prepare-release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: avicore
            asset_name: avicore-${{ needs.prepare-release.outputs.version }}-linux-x86_64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact_name: avicore
            asset_name: avicore-${{ needs.prepare-release.outputs.version }}-linux-aarch64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: avicore
            asset_name: avicore-${{ needs.prepare-release.outputs.version }}-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: avicore
            asset_name: avicore-${{ needs.prepare-release.outputs.version }}-macos-aarch64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: avicore.exe
            asset_name: avicore-${{ needs.prepare-release.outputs.version }}-windows-x86_64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}
          cache: true
      
      - name: Install cross-compilation tools (Linux ARM)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
      
      - name: Update Cargo.toml version
        shell: bash
        run: |
          if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS sed syntax
            sed -i '' 's/^version = ".*"/version = "${{ needs.prepare-release.outputs.version }}"/' Cargo.toml
          else
            # Linux sed syntax
            sed -i 's/^version = ".*"/version = "${{ needs.prepare-release.outputs.version }}"/' Cargo.toml
          fi
          echo "Updated version in Cargo.toml to ${{ needs.prepare-release.outputs.version }}"
      
      - name: Build release
        run: |
          cargo build --release --target ${{ matrix.target }} --verbose
      
      #- name: Run tests
      #  # Skip tests for cross-compiled targets
      #  if: matrix.target == 'x86_64-unknown-linux-gnu' || matrix.target == 'x86_64-apple-darwin' || matrix.target == 'x86_64-pc-windows-msvc' || matrix.target == 'aarch64-apple-darwin'
      #  run: |
      #    cargo test --release --target ${{ matrix.target }} --verbose
      
      - name: Package binary (Unix)
        if: runner.os != 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          
          # Create tarball
          tar -czf ${{ matrix.asset_name }}.tar.gz ${{ matrix.artifact_name }}
          
          # Create checksum
          shasum -a 256 ${{ matrix.asset_name }}.tar.gz > ${{ matrix.asset_name }}.tar.gz.sha256
          
          echo "Created archive and checksum"
          ls -lh ${{ matrix.asset_name }}*
      
      - name: Package binary (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          cd target/${{ matrix.target }}/release
          
          # Create zip archive
          7z a ${{ matrix.asset_name }}.zip ${{ matrix.artifact_name }}
          
          # Create checksum
          sha256sum ${{ matrix.asset_name }}.zip > ${{ matrix.asset_name }}.zip.sha256
          
          echo "Created archive and checksum"
          ls -lh ${{ matrix.asset_name }}*
      
      - name: Upload artifacts (Unix)
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: |
            target/${{ matrix.target }}/release/${{ matrix.asset_name }}.tar.gz
            target/${{ matrix.target }}/release/${{ matrix.asset_name }}.tar.gz.sha256
      
      - name: Upload artifacts (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: |
            target/${{ matrix.target }}/release/${{ matrix.asset_name }}.zip
            target/${{ matrix.target }}/release/${{ matrix.asset_name }}.zip.sha256
  
  create-release:
    needs: [prepare-release, build-binaries]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: Display artifact structure
        run: |
          ls -R ./artifacts
      
      - name: Create or update git tag
        run: |
          VERSION_TAG="${{ needs.prepare-release.outputs.version_tag }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create tag
          git tag -a "${VERSION_TAG}" -m "Release ${VERSION_TAG}"
          git push origin "${VERSION_TAG}"
          
          echo "Created and pushed tag: ${VERSION_TAG}"
      
      - name: Create GitHub Release
        run: |
          VERSION_TAG="${{ needs.prepare-release.outputs.version_tag }}"
          VERSION="${{ needs.prepare-release.outputs.version }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          HAS_VERSION="${{ needs.prepare-release.outputs.has_version }}"
          
          # Create release notes
          if [ "${HAS_VERSION}" == "true" ]; then
            RELEASE_TYPE="New Version Release"
            PRERELEASE_FLAG=""
          else
            RELEASE_TYPE="Updated Release"
            PRERELEASE_FLAG="--prerelease"
          fi
          
          cat > release_notes.md << EOF
          # ${RELEASE_TYPE} - ${VERSION_TAG}
          
          **PR #${PR_NUMBER}:** ${PR_TITLE}
          **Version:** ${VERSION}
          
          ## Changes
          Merged PR #${PR_NUMBER}: ${{ github.event.pull_request.html_url }}
          
          ## Installation
          
          ### Linux (x86_64)
          \`\`\`bash
          wget https://github.com/${{ github.repository }}/releases/download/${VERSION_TAG}/avicore-${VERSION}-linux-x86_64.tar.gz
          tar -xzf avicore-${VERSION}-linux-x86_64.tar.gz
          ./avicore
          \`\`\`
          
          ### Linux (ARM64/aarch64)
          \`\`\`bash
          wget https://github.com/${{ github.repository }}/releases/download/${VERSION_TAG}/avicore-${VERSION}-linux-aarch64.tar.gz
          tar -xzf avicore-${VERSION}-linux-aarch64.tar.gz
          ./avicore
          \`\`\`
          
          ### macOS (Intel)
          \`\`\`bash
          wget https://github.com/${{ github.repository }}/releases/download/${VERSION_TAG}/avicore-${VERSION}-macos-x86_64.tar.gz
          tar -xzf avicore-${VERSION}-macos-x86_64.tar.gz
          ./avicore
          \`\`\`
          
          ### macOS (Apple Silicon)
          \`\`\`bash
          wget https://github.com/${{ github.repository }}/releases/download/${VERSION_TAG}/avicore-${VERSION}-macos-aarch64.tar.gz
          tar -xzf avicore-${VERSION}-macos-aarch64.tar.gz
          ./avicore
          \`\`\`
          
          ### Windows (x86_64)
          Download the zip file and extract it:
          \`\`\`powershell
          Invoke-WebRequest -Uri "https://github.com/${{ github.repository }}/releases/download/${VERSION_TAG}/avicore-${VERSION}-windows-x86_64.zip" -OutFile "avicore-${VERSION}-windows-x86_64.zip"
          Expand-Archive -Path "avicore-${VERSION}-windows-x86_64.zip" -DestinationPath .
          .\avicore.exe
          \`\`\`
          
          ## Verification
          
          All archives include SHA256 checksums for verification:
          
          \`\`\`bash
          # Linux/macOS
          wget https://github.com/${{ github.repository }}/releases/download/${VERSION_TAG}/avicore-${VERSION}-linux-x86_64.tar.gz.sha256
          sha256sum -c avicore-${VERSION}-linux-x86_64.tar.gz.sha256
          
          # Windows (PowerShell)
          \$hash = Get-FileHash avicore-${VERSION}-windows-x86_64.zip -Algorithm SHA256
          \$expectedHash = Get-Content avicore-${VERSION}-windows-x86_64.zip.sha256
          if (\$hash.Hash -eq \$expectedHash.Split()[0]) { Write-Host "Checksum verified!" }
          \`\`\`
          EOF
          
          # Prepare all artifact files
          find ./artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.sha256" \) -exec echo {} \;
          
          # Create the release
          gh release create "${VERSION_TAG}" \
            --title "${VERSION_TAG}: ${PR_TITLE}" \
            --notes-file release_notes.md \
            ${PRERELEASE_FLAG} \
            ./artifacts/*/*.tar.gz \
            ./artifacts/*/*.tar.gz.sha256 \
            ./artifacts/*/*.zip \
            ./artifacts/*/*.zip.sha256
          
          echo "Release created: ${VERSION_TAG}"
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Create PR comment with release links
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const version = '${{ needs.prepare-release.outputs.version }}';
            const tag = '${{ needs.prepare-release.outputs.version_tag }}';
            const hasVersion = '${{ needs.prepare-release.outputs.has_version }}' === 'true';
            const releaseUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${tag}`;
            const baseUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/releases/download/${tag}`;
            
            const releaseType = hasVersion ? 'ðŸŽ‰ New Version Released' : 'ðŸ”„ Release Updated';
            
            const comment = `## ${releaseType}
            
            **Version:** \`${version}\`
            **Tag:** \`${tag}\`
            
            ### ðŸ“¦ Download Release
            Your merged PR has been built and published for all platforms:
            
            ðŸ”— **[View Release](${releaseUrl})**
            
            ### Quick Install
            
            **Linux (x86_64)**
            \`\`\`bash
            wget ${baseUrl}/avicore-${version}-linux-x86_64.tar.gz
            tar -xzf avicore-${version}-linux-x86_64.tar.gz
            ./avicore
            \`\`\`
            
            **Linux (ARM64)**
            \`\`\`bash
            wget ${baseUrl}/avicore-${version}-linux-aarch64.tar.gz
            tar -xzf avicore-${version}-linux-aarch64.tar.gz
            ./avicore
            \`\`\`
            
            **macOS (Intel)**
            \`\`\`bash
            wget ${baseUrl}/avicore-${version}-macos-x86_64.tar.gz
            tar -xzf avicore-${version}-macos-x86_64.tar.gz
            ./avicore
            \`\`\`
            
            **macOS (Apple Silicon)**
            \`\`\`bash
            wget ${baseUrl}/avicore-${version}-macos-aarch64.tar.gz
            tar -xzf avicore-${version}-macos-aarch64.tar.gz
            ./avicore
            \`\`\`
            
            **Windows (x86_64)**
            \`\`\`powershell
            Invoke-WebRequest -Uri "${baseUrl}/avicore-${version}-windows-x86_64.zip" -OutFile "avicore.zip"
            Expand-Archive -Path "avicore.zip" -DestinationPath .
            .\\avicore.exe
            \`\`\`
            
            ### ðŸ” Checksums
            SHA256 checksums are available for all downloads to verify integrity.
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
