name: PR Checks

on:
  pull_request:
    branches:
      - master
      - main
      - develop

env:
  CARGO_TERM_COLOR: always

jobs:
  check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
          cache: true
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-
      
      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-
      
      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-check-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-target-check-
            ${{ runner.os }}-target-
      
      - name: Check formatting
        run: |
          cargo fmt --all -- --check
      
      - name: Run Clippy
        run: |
          cargo clippy --all-targets --all-features -- -D warnings
      
      - name: Check build
        run: |
          cargo check --all-targets --all-features --verbose
      
      #- name: Run tests
      #  run: |
      #    cargo test --all-features --verbose
      
      #- name: Run doc tests
      #  run: |
      #    cargo test --doc --all-features --verbose
      
      #- name: Check documentation
      #  run: |
      #    cargo doc --no-deps --all-features --document-private-items
       # env:
       #   RUSTDOCFLAGS: -D warnings
      
      - name: Post check summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const conclusion = '${{ job.status }}';
            
            let emoji = '✅';
            let status = 'All checks passed!';
            
            if (conclusion !== 'success') {
              emoji = '❌';
              status = 'Some checks failed. Please review the logs above.';
            }
            
            const comment = `## ${emoji} PR Checks ${conclusion === 'success' ? 'Passed' : 'Failed'}
            
            ${status}
            
            **Checks run:**
            - Code formatting (\`cargo fmt\`)
            - Linting (\`cargo clippy\`)
            - Build verification (\`cargo check\`)
            - Unit tests (\`cargo test\`)
            - Documentation tests (\`cargo test --doc\`)
            - Documentation build (\`cargo doc\`)
            
            ${conclusion === 'success' ? '✨ Ready for review!' : '⚠️ Please fix the issues and push again.'}
            `;
            
            // Only post comment if checks failed
            if (conclusion !== 'success') {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
